<!DOCTYPE html>
<html>

<head>
    <title>Read CSV</title>
    <script type="text/javascript" src="papaparse.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="main.css">

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">SQL Converter</a>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a href="https://www.restedbox.com" target="_blank" class="nav-link">RestedBox</a>
            </li>

        </ul>
    </nav>
    <div class="d-flex flex-column height justify-content-center align-items-center">

        <div class="top row ">
            <div class="col-md-12">
                <p>Upload a CSV with headers and rows to generate SQL insert scripts.<br>We care about your privacy, so the data <strong>never</strong> leaves the browser.<br><a href=""
                        onclick="downloadSample()">Download</a> the sample CSV to get started.</p>
            </div>
        </div>

        <div class="upload row ">
            <div class="col-md-12">
                <form id="form">
                    <div class="custom-file mb-3">
                        <input type="file" class="custom-file-input" id="upload-csv" name="filename" accept=".csv">
                        <label class="custom-file-label" for="customFile">Choose file</label>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="tableName" aria-describedby="tableHelp"
                            placeholder="Enter table name" required>
                    </div>
                    <br>
                    <button type="submit button" class="btn btn-primary" id="btn-upload-csv">Generate SQL</button>

                </form>
            </div>


        </div>
    </div>
    <script type="text/javascript">
        function downloadSample() {
            let prefix = "data:text/csv;charset=utf-8,";
            let header = "username,email,user_id,last_login";
            let csvContent = header + "\r\n";
            csvContent += "test1,test1@test.com,1,6/21/2021 13:01" + "\r\n";
            csvContent += "test2,test2@test.com,1,6/22/2021 13:01" + "\r\n";
            csvContent += "test3,test3@test.com,1,6/23/2021 13:01";

            var encodedUri = prefix + encodeURIComponent(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sample.csv");
            document.body.appendChild(link);
            link.click();
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        $(".custom-file-input").on("change", function () {
            var fileName = $(this).val().split("\\").pop();
            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
        });

        const form = document.getElementById('form');

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            var tableName = document.getElementById("tableName").value;


            Papa.parse(document.getElementById('upload-csv').files[0], {
                download: true,
                header: true,
                complete: function (results) {
                    var columns = results.meta.fields;
                    var columnsJoined = columns.join();
                    var rows = [];
                    for (var j = 0; j < results.data.length; j++) {
                        var currentRow = "";
                        for (var i = 0; i < columns.length; i++) {
                            if (results.data[j][columns[i]]) {
                                currentRow += "'" + (results.data[j][columns[i]]) + "'" + ((i < columns.length - 1) ? "," : "");
                            } else {
                                currentRow += 'NULL' + ((i < columns.length - 1) ? "," : "");
                            }

                        }
                        rows.push(currentRow);
                    }
                    var batches = 10;
                    var batchedRows = [];
                    while (rows.length) {
                        batchedRows.push(rows.splice(0, 10));
                    }
                    var batch;
                    var sql = "";
                    for(var i = 0; i < batchedRows.length; i++) {
                        sql += "INSERT into " + tableName + " (" + columnsJoined + ") VALUES ";
                        batch = "";
                        for(var j = 0; j < batchedRows[i].length; j++) {
                            if(j == batchedRows[i].length - 1) {
                                batch += "(" + batchedRows[i][j] + ");";
                            } else {
                                batch += "(" + batchedRows[i][j] + "),";
                            }
                        }
                        sql += batch + "\r\n";
                    }

                    download('SQLGeneratorScripts_' + tableName + '.sql', sql);
                }
            });
        });
    </script>
</body>

<footer class="bg-light text-center text-lg-start">
    <!-- Copyright -->
    <div class="text-center p-3">
      SQL Converter - Created by <a href="https://www.restedbox.com" target="_blank">RestedBox</a>
    </div>
    <!-- Copyright -->
  </footer>

</html>